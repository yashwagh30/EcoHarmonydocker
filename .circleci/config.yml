version: 2.1

jobs:
  build-and-deploy:
    docker:
      - image: cimg/base:2023.09
    steps:
      - checkout
      
      # SSH Setup using CircleCI's SSH key management
      - add_ssh_keys:
          fingerprints:
            - "SHA256:V2xbQe05p9W5NsIZbpuAganMax2wZ8S657MLq9L33fM"
      
      # Verify SSH connection
      - run:
          name: Test SSH Connection
          command: |
            ssh -o StrictHostKeyChecking=no ec2-user@13.201.87.22 "echo 'SSH connection successful!'"
      
      # Docker Setup
      - setup_remote_docker
      
      # Docker Login
      - run:
          name: Docker Login
          command: |
            docker login -u "yashwagh30" -p "Y@shdocker30"

      # Build and Push
      - run:
          name: Build and Push Docker Image
          command: |
            docker build -t yashwagh30/ecoharmony:latest .
            docker push yashwagh30/ecoharmony:latest
      
      # Deployment (Fixed heredoc syntax)
      - run:
          name: Deploy to EC2
          command: |
            ssh -o StrictHostKeyChecking=no ec2-user@13.201.87.22 << 'ENDSSH'
            docker pull yashwagh30/ecoharmony:latest
            docker stop ecoharmony-container || true
            docker rm ecoharmony-container || true
            docker run -d -p 80:80 --name ecoharmony-container yashwagh30/ecoharmony:latest
            ENDSSH

workflows:
  version: 2
  deploy:
    jobs:
      - build-and-deploy
